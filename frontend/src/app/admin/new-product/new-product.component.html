<app-header [message]="'New Product'"></app-header>
<form #productForm="ngForm" (ngSubmit)="store.onSubmit(productForm)" class="d-flex flex-column gap-2 p-3">
  @if(store.message()){<h2 style="color:green;font-weight:bold">{{store.message()}}</h2>}
  <div class="section">
    <h3 class="fw-bold">Upload images</h3>
    <input type="file" name="images" (change)="store.filesChanged($event)" multiple>

    <mat-label class="mt-3">Choose saving option</mat-label>
    <mat-radio-group name="savingOption" [ngModel]="product().savingOption" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {savingOption: $event}))">
      <mat-radio-button [value]="0">cloud</mat-radio-button>
      <mat-radio-button [value]="1">database</mat-radio-button>
    </mat-radio-group>

    @if(store.productId()){
      <h3 class="fw-bold">Existing images</h3>
      <div class="d-flex flex-wrap gap-2">
          @for(image of store.images();track image.id;let i=$index){
            <div class="position-relative">
            @if(image.savingOption==0){
              <img mat-card-image [src]="image.url">
            }
            @else{
              <img mat-card-image [src]="store.imageUrls()[i]">
            }
            <button type="button" mat-icon-button class="position-absolute top-0 end-0 deleteButton" (click)="store.deleteImage(image.id,i)"><mat-icon>close</mat-icon></button>
            </div>
          }
      </div>
    }
  </div>


  <div class="section">
    <h3 class="fw-bold">General information</h3>
    <mat-form-field>
      <mat-label>Name</mat-label>
      <input matInput name="name" [ngModel]="product().name" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {name: $event}))" required>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Description</mat-label>
      <input matInput name="description" [ngModel]="product().description" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {description: $event}))" required>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Price</mat-label>
      <input matInput type="number" name="price" [ngModel]="product().price" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {price: $event}))" required>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Discount</mat-label>
      <input matInput type="number" name="discount" [ngModel]="product().discount" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {discount: $event}))" required>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Stock</mat-label>
      <input matInput type="number" name="stock" [ngModel]="product().stock" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {stock: $event}))" min="1" required>
    </mat-form-field>
  </div>

  <div class="section">
    <h3 class="fw-bold">Category</h3>
    <mat-form-field>
      <mat-label>New category(optional)</mat-label>
      <input matInput name="category" [ngModel]="product().newCategory" (ngModelChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {newCategory: $event}))">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Select existing categories</mat-label>
      <mat-select [value]="product().productCategory" (selectionChange)="store.updateProduct(Object.assign(emptyProduct(), product(), {productCategory: $event}))">
        @for (category of store.categories(); track category.name) {
          <mat-option [value]="category.name">{{ category.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  @if(store.productId()){
    <div class="section">
      <h3 class="fw-bold">Reviews</h3>
      @for(review of store.reviews();track review.id;let i=$index){
        <div class="review">

          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex gap-3">
              <span><b>Username:</b> {{review.postedBy}}</span>
              <div>
                @for(i of getStars(review.rating);track i){‚≠ê}
              </div>
            </div>
            <span>{{getDate(review.createdAt)}}</span>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <span>{{review.text}}</span>
            <button mat-icon-button color="primary" type="button" aria-label="delete review" (click)="store.deleteReview(review.id,i)"><mat-icon>delete</mat-icon></button>
          </div>
        </div>
      }
    </div>
  }
  <div class="d-flex justify-content-end mt-3">
    <button mat-raised-button color="primary" type="submit">
      Save Product
    </button>
  </div>

</form>


<app-notification></app-notification>
